# E23. WebSocket åŒå‘å³æ—¶é€šä¿¡
## 3.1. ğŸŒŸ WebSocket è§£å†³ HTTP çš„æ ¸å¿ƒé—®é¢˜

> WebSocket æ˜¯ HTML5 æ ‡å‡†åè®®ï¼Œé€šè¿‡æŒä¹…è¿æ¥è§£å†³ HTTP åè®®çš„å•å‘è¯·æ±‚-å“åº”æ¨¡å¼ç¼ºé™·ï¼Œå®ç°å…¨åŒå·¥å®æ—¶é€šä¿¡ã€‚

### HTTP çš„å±€é™æ€§
```javascript
// ä¼ ç»Ÿè½®è¯¢ç¤ºä¾‹ï¼ˆé«˜å»¶è¿Ÿã€é«˜å¼€é”€ï¼‰
setInterval(() => {
  fetch('/api/data')
    .then(res => res.json())
    .then(data => console.log(data));
}, 2000); // æ¯ 2 ç§’è½®è¯¢
```

### WebSocket çš„ä¼˜åŠ¿
```diff
+ å…¨åŒå·¥é€šä¿¡ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å¯éšæ—¶åŒå‘ä¼ è¾“æ•°æ®
+ æŒä¹…è¿æ¥ï¼šè¿æ¥å»ºç«‹åæ— éœ€é‡å¤æ¡æ‰‹ï¼ˆå‡å°‘ TCP æ¡æ‰‹å¼€é”€ï¼‰
+ ä½åè®®å¼€é”€ï¼šæ•°æ®å¸§å¤´éƒ¨ä»… 2-10 å­—èŠ‚ï¼ˆHTTP å¤´éƒ¨å¯è¾¾ KB çº§ï¼‰
```

### WebSocket ä¸ HTTP çš„å…³ç³»
```mermaid
graph LR
    A[HTTP 1.1 è¯·æ±‚] --> B[Upgrade: websocket å¤´éƒ¨]
    B --> C{æœåŠ¡å™¨å“åº”}
    C -->|101 Switching Protocols| D[WebSocket è¿æ¥å»ºç«‹]
    D --> E[åŒå‘æ•°æ®ä¼ è¾“]
```
## 3.2. ğŸŒŸ WebSocket å·¥ä½œåŸç†ä¸æ¡æ‰‹æµç¨‹

> WebSocket é€šè¿‡ HTTP åè®®å‡çº§å®ç°è¿æ¥å»ºç«‹ï¼Œåç»­é€šä¿¡åŸºäº TCP äºŒè¿›åˆ¶å¸§ã€‚

### æ¡æ‰‹è¿‡ç¨‹è¯¦è§£
```text
// å®¢æˆ·ç«¯è¯·æ±‚
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13

// æœåŠ¡ç«¯å“åº”
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
```

### æ•°æ®å¸§æ ¼å¼
```javascript
// WebSocket æ•°æ®å¸§ç»“æ„ï¼ˆäºŒè¿›åˆ¶ï¼‰
{
  fin: 1,       // æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªåˆ†ç‰‡
  rsv: 0,       // æ‰©å±•ä½ï¼ˆéœ€åå•†ï¼‰
  opcode: 1,    // æ“ä½œç ï¼ˆ1=æ–‡æœ¬ï¼Œ2=äºŒè¿›åˆ¶ï¼‰
  mask: true,   // å®¢æˆ·ç«¯å‘é€éœ€æ©ç ï¼ˆæœåŠ¡ç«¯ä¸éœ€ï¼‰
  payload: 'Hello' // åŠ å¯†æˆ–æœªåŠ å¯†æ•°æ®
}
```
## 3.3. ğŸŒŸ socket.ioï¼šWebSocket çš„å¢å¼ºå®ç°

> socket.io æ˜¯åŸºäº WebSocket çš„åº“ï¼Œæä¾›è‡ªåŠ¨é™çº§ã€äº‹ä»¶ç»‘å®šã€å‘½åç©ºé—´ç­‰ç‰¹æ€§ã€‚

### æ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”
| ç‰¹æ€§                | WebSocket åŸç”Ÿ | socket.io          |
|---------------------|----------------|--------------------|
| è¿æ¥åè®®            | ws/wss         | ws/wssï¼ˆæˆ–é•¿è½®è¯¢ï¼‰ |
| äº‹ä»¶é©±åŠ¨            | éœ€è‡ªè¡Œå°è£…     | å†…ç½®äº‹ä»¶ç³»ç»Ÿ       |
| è‡ªåŠ¨é‡è¿            | éœ€æ‰‹åŠ¨å®ç°     | å†…ç½®æ”¯æŒ           |
| å‘½åç©ºé—´            | ä¸æ”¯æŒ         | æ”¯æŒ               |

### socket.io æœåŠ¡ç«¯ç¤ºä¾‹
```javascript
// server.mjs
import { Server } from 'socket.io';

const io = new Server({ cors: true });

io.on('connection', (socket) => {
  console.log('å®¢æˆ·ç«¯è¿æ¥:', socket.id);

  socket.on('chat message', (msg) => {
    io.emit('chat message', msg); // å¹¿æ’­æ¶ˆæ¯
  });

  socket.on('disconnect', () => {
    console.log('å®¢æˆ·ç«¯æ–­å¼€:', socket.id);
  });
});

io.listen(3000);
```
## 3.4. ğŸŒŸ WebSocket å…¸å‹åº”ç”¨åœºæ™¯

### å®æ—¶èŠå¤©ç³»ç»Ÿ
```javascript
// å®¢æˆ·ç«¯ä»£ç ï¼ˆæµè§ˆå™¨ï¼‰
const socket = new WebSocket('ws://localhost:3000');

socket.addEventListener('open', () => {
  socket.send('Hello Server');
});

socket.addEventListener('message', (event) => {
  console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
});
```

### å®æ—¶æ•°æ®ä»ªè¡¨ç›˜
```javascript
// æœåŠ¡ç«¯æ¨é€å®æ—¶æ•°æ®
setInterval(() => {
  const data = generateRealtimeData();
  io.emit('realtime-data', data);
}, 1000);
```

### æ¸¸æˆå¤šäººåŒæ­¥
```javascript
// å‘½åç©ºé—´éš”ç¦»æ¸¸æˆæˆ¿é—´
io.of('/game').on('connection', (socket) => {
  socket.join('room1');
  socket.on('player-move', (position) => {
    socket.to('room1').emit('player-update', position);
  });
});
```
## 3.5. âš ï¸ WebSocket å®‰å…¨ä¸ä¼˜åŒ–

### å®‰å…¨æªæ–½
```diff
+ ä½¿ç”¨ wss:// åŠ å¯†ä¼ è¾“ï¼ˆTLSï¼‰
+ éªŒè¯å®¢æˆ·ç«¯èº«ä»½ï¼ˆToken é‰´æƒï¼‰
+ é™åˆ¶æ¶ˆæ¯é¢‘ç‡ï¼ˆé˜²æ´ªæ°´æ”»å‡»ï¼‰
- é¿å…æ˜æ–‡ä¼ è¾“æ•æ„Ÿæ•°æ®
```

### æ€§èƒ½ä¼˜åŒ–
```javascript
// å‹ç¼©æ•°æ®ï¼ˆéœ€æœåŠ¡ç«¯æ”¯æŒï¼‰
const socket = new WebSocket('ws://server', ['permessage-deflate']);

// æœåŠ¡ç«¯é…ç½®å¿ƒè·³æ£€æµ‹
io.listen(3000).httpServer;
io.engine.config.timeout = 60000; // 60ç§’è¶…æ—¶
```
## çŸ¥è¯†å›é¡¾

1. **æ ¸å¿ƒä¼˜åŠ¿**ï¼šå…¨åŒå·¥ã€ä½å»¶è¿Ÿã€æŒä¹…è¿æ¥ï¼Œè§£å†³ HTTP è½®è¯¢çš„é«˜å¼€é”€é—®é¢˜ã€‚
2. **æ¡æ‰‹æµç¨‹**ï¼šé€šè¿‡ HTTP Upgrade å¤´éƒ¨å‡çº§åè®®ï¼ŒæœåŠ¡ç«¯è¿”å› 101 çŠ¶æ€ç ã€‚
3. **æ•°æ®æ ¼å¼**ï¼šäºŒè¿›åˆ¶å¸§åŒ…å«åˆ†ç‰‡ã€æ©ç ã€æ“ä½œç ç­‰å­—æ®µã€‚
4. **socket.io æ‰©å±•**ï¼šè‡ªåŠ¨é™çº§ã€äº‹ä»¶ç³»ç»Ÿã€å‘½åç©ºé—´ç­‰é«˜çº§ç‰¹æ€§ã€‚
5. **å…¸å‹åœºæ™¯**ï¼šå®æ—¶èŠå¤©ã€æ¸¸æˆåŒæ­¥ã€æ•°æ®ä»ªè¡¨ç›˜ç­‰éœ€è¦åŒå‘é€šä¿¡çš„åœºæ™¯ã€‚
## è¯¾åç»ƒä¹ 

1. ï¼ˆå•é€‰ï¼‰WebSocket è¿æ¥å»ºç«‹æ—¶ï¼ŒæœåŠ¡ç«¯å“åº”çš„ HTTP çŠ¶æ€ç æ˜¯ï¼š
   - A. 200 OK
   - B. 101 Switching Protocols
   - C. 404 Not Found
   - D. 500 Internal Server Error

2. ï¼ˆå¡«ç©ºï¼‰WebSocket æ•°æ®å¸§ä¸­ï¼Œå®¢æˆ·ç«¯å‘é€çš„æ•°æ®éœ€ç»è¿‡ ______ å¤„ç†ã€‚

3. ï¼ˆç¼–ç¨‹ï¼‰ä½¿ç”¨ socket.io å®ç°ä¸€ä¸ªç®€å•èŠå¤©å®¤ï¼š
   - å®¢æˆ·ç«¯è¾“å…¥æ¶ˆæ¯åå¹¿æ’­ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ã€‚
   - æœåŠ¡ç«¯è®°å½•å¹¶æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·æ•°é‡ã€‚

:::details å‚è€ƒç­”æ¡ˆ
1. B
2. **æ©ç ï¼ˆmaskï¼‰**
3. ```javascript
   // æœåŠ¡ç«¯ï¼ˆserver.mjsï¼‰
   import { Server } from 'socket.io';
   const io = new Server({ cors: true });
   let users = 0;

   io.on('connection', (socket) => {
     users++;
     socket.emit('online-count', users);
     socket.broadcast.emit('new-user', users);

     socket.on('chat-message', (msg) => {
       io.emit('chat-message', msg);
     });

     socket.on('disconnect', () => {
       users--;
       io.emit('online-count', users);
     });
   });

   io.listen(3000);

   // å®¢æˆ·ç«¯ï¼ˆclient.jsï¼‰
   const socket = io('http://localhost:3000');

   socket.on('connect', () => {
     console.log('Connected:', socket.id);
   });

   socket.on('chat-message', (msg) => {
     console.log('æ”¶åˆ°æ¶ˆæ¯:', msg);
   });

   socket.on('online-count', (count) => {
     console.log('å½“å‰åœ¨çº¿:', count);
   });

   document.querySelector('button').addEventListener('click', () => {
     const msg = document.getElementById('message').value;
     socket.emit('chat-message', msg);
   });
   ```
:::
## æ‰©å±•é˜…è¯»
- [WebSocket RFC 6455 æ ‡å‡†](https://tools.ietf.org/html/rfc6455)
- [socket.io å®˜æ–¹æ–‡æ¡£](https://socket.io/docs/v4/)
- [WebSocket å®‰å…¨æŒ‡å—](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket#å®‰å…¨è€ƒè™‘)
