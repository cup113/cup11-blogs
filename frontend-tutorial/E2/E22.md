# E22. Express.js ç«¯å£ç›‘å¬

## 2.1. ğŸŒŸ Express.js åŸºäº http æ¨¡å—å®ç°

> Express æ˜¯å¯¹ Node.js åŸç”Ÿ `http` æ¨¡å—çš„å°è£…ï¼Œæä¾›æ›´ç®€æ´çš„ APIã€‚é€šè¿‡å¯¹æ¯”åŸç”Ÿä»£ç ä¸ Express å®ç°ï¼Œç†è§£å…¶æ ¸å¿ƒæ€æƒ³ã€‚

### åŸç”Ÿ http æ¨¡å—ä»£ç 
```javascript
// server-http.mjs
import http from 'node:http';

const server = http.createServer((req, res) => {
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.end('Hello HTTP!');
});

server.listen(3000, () => {
  console.log('HTTP Server running on port 3000');
});
```

### Express ç®€åŒ–ä»£ç 
```javascript
// server-express.mjs
import express from 'express';
const app = express();

app.get('/', (req, res) => {
  res.send('Hello Express!');
});

app.listen(3000, () => {
  console.log('Express Server running on port 3000');
});
```

:::tip
- Express çš„ `app` å¯¹è±¡æœ¬è´¨æ˜¯ `http.Server` çš„å°è£…ï¼Œé€šè¿‡ `app.listen()` å¯åŠ¨æœåŠ¡å™¨ã€‚
- `app.get()`ã€`app.post()` ç­‰æ–¹æ³•è‡ªåŠ¨ç»‘å®šåˆ° `http.Server` çš„è·¯ç”±å¤„ç†é€»è¾‘ã€‚
:::
## 2.2. ğŸŒŸ app å¯¹è±¡ä¸Šçš„ GET/POST æ–¹æ³•æ·»åŠ ç›‘å¬è·¯å¾„

> é€šè¿‡ `app.METHOD()` å®šä¹‰è·¯ç”±ï¼Œ`METHOD` æ˜¯ HTTP æ–¹æ³•ï¼ˆå¦‚ `get`ã€`post`ï¼‰ï¼Œ`PATH` æ˜¯ URL è·¯å¾„ã€‚

### åŸºç¡€è·¯ç”±ç¤ºä¾‹
```javascript
// routes.mjs
import express from 'express';
const app = express();

// GET è¯·æ±‚
app.get('/api/data', (req, res) => {
  res.json({ message: 'GET è¯·æ±‚å“åº”' });
});

// POST è¯·æ±‚
app.post('/api/data', (req, res) => {
  res.send('POST è¯·æ±‚å·²æ¥æ”¶');
});

app.listen(3000);
```

### è·¯å¾„å‚æ•°ä¸æŸ¥è¯¢å‚æ•°
```javascript
// åŠ¨æ€è·¯å¾„å‚æ•°ï¼ˆ:idï¼‰
app.get('/user/:id', (req, res) => {
  res.send(`ç”¨æˆ·IDï¼š${req.params.id}`);
});

// æŸ¥è¯¢å‚æ•°ï¼ˆ?name=xxxï¼‰
app.get('/search', (req, res) => {
  res.send(`æœç´¢å…³é”®è¯ï¼š${req.query.name}`);
});
```
## 2.3. ğŸŒŸ request å’Œ response çš„æ ¸å¿ƒæ–¹æ³•

> `req` æ˜¯è¯·æ±‚å¯¹è±¡ï¼Œ`res` æ˜¯å“åº”å¯¹è±¡ï¼Œæä¾›ä¸°å¯Œçš„æ–¹æ³•å¤„ç†è¯·æ±‚å’Œå“åº”ã€‚

### å¸¸ç”¨ req æ–¹æ³•
```javascript
// ç¤ºä¾‹ï¼šè·å–è¯·æ±‚æ–¹æ³•ã€è·¯å¾„ã€æŸ¥è¯¢å‚æ•°
app.get('/test', (req, res) => {
  res.send(`
    æ–¹æ³•ï¼š${req.method}<br>
    è·¯å¾„ï¼š${req.path}<br>
    æŸ¥è¯¢å‚æ•°ï¼š${JSON.stringify(req.query)}
  `);
});
```

### å¸¸ç”¨ res æ–¹æ³•
```javascript
// å‘é€ä¸åŒæ ¼å¼çš„å“åº”
app.get('/json', (req, res) => {
  res.json({ status: 'success' }); // JSON æ ¼å¼
});

app.get('/html', (req, res) => {
  res.send('<h1>HTML å†…å®¹</h1>'); // HTML å­—ç¬¦ä¸²
});

app.get('/redirect', (req, res) => {
  res.redirect('https://expressjs.com'); // é‡å®šå‘
});
```

:::warning
- `res.send()` ä¼šè‡ªåŠ¨è®¾ç½® `Content-Type`ï¼Œä¾‹å¦‚å‘é€ JSON æ—¶éœ€ç”¨ `res.json()`ã€‚
- `req.body` éœ€é€šè¿‡ `express.json()` æˆ– `express.urlencoded()` ä¸­é—´ä»¶è§£æã€‚
:::
## 2.4. â­ next æ˜¯ä¸­é—´ä»¶ (middleware) çš„åŸºç¡€

> ä¸­é—´ä»¶é€šè¿‡ `next()` ä¼ é€’æ§åˆ¶æƒï¼Œå½¢æˆå¤„ç†é“¾ã€‚æ ¸å¿ƒä½œç”¨åŒ…æ‹¬æ—¥å¿—ã€èº«ä»½éªŒè¯ã€è·¯ç”±å¤„ç†ç­‰ã€‚

### ä¸­é—´ä»¶åŸºæœ¬ç»“æ„
```javascript
// middleware-example.mjs
app.use((req, res, next) => {
  console.log(`è¯·æ±‚è·¯å¾„ï¼š${req.path}`);
  next(); // å¿…é¡»è°ƒç”¨ next() ä¼ é€’æ§åˆ¶æƒ
});
```

### è·¯ç”±çº§ä¸­é—´ä»¶
```javascript
// ä»…å¯¹ç‰¹å®šè·¯ç”±ç”Ÿæ•ˆçš„ä¸­é—´ä»¶
app.get('/protected', (req, res, next) => {
  if (req.query.token === '123') {
    next(); // ç»§ç»­åç»­å¤„ç†
  } else {
    res.status(401).send('æœªæˆæƒ');
  }
}, (req, res) => {
  res.send('å—ä¿æŠ¤çš„èµ„æº');
});
```
## 2.5. ğŸŒŸ ä½¿ç”¨ä¸­é—´ä»¶æ”¯æŒ JSON ä¼ è¾“å’Œé™æ€æ–‡ä»¶æœåŠ¡

> Express æä¾›å†…ç½®ä¸­é—´ä»¶ `express.json()` å’Œ `express.static()`ï¼Œç®€åŒ–å¸¸è§åŠŸèƒ½å¼€å‘ã€‚

### è§£æ JSON è¯·æ±‚ä½“
```javascript
// è§£æ JSON æ ¼å¼çš„ POST è¯·æ±‚ä½“
app.use(express.json());

app.post('/api/data', (req, res) => {
  console.log('æ”¶åˆ°çš„æ•°æ®ï¼š', req.body);
  res.json({ received: true });
});
```

### æä¾›é™æ€æ–‡ä»¶æœåŠ¡
```javascript
// é…ç½®é™æ€æ–‡ä»¶ç›®å½•ï¼ˆå¦‚ public æ–‡ä»¶å¤¹ï¼‰
app.use(express.static('public'));

// æ–‡ä»¶ç»“æ„ç¤ºä¾‹ï¼š
// public/
//   index.html
//   css/style.css
//   img/logo.png
```

:::details ä¾‹ï¼šå®Œæ•´é™æ€æ–‡ä»¶æœåŠ¡é…ç½®
```javascript
import path from 'node:path';
import express from 'express';

const app = express();
const __dirname = path.resolve();

app.use(express.static(path.join(__dirname, 'public')));

app.listen(3000, () => {
  console.log('é™æ€èµ„æºæœåŠ¡å¯åŠ¨');
});
```
:::
## çŸ¥è¯†å›é¡¾

1. **Express æœ¬è´¨**ï¼šåŸºäº `http` æ¨¡å—å°è£…ï¼Œé€šè¿‡ `app.listen()` å¯åŠ¨æœåŠ¡å™¨ã€‚
2. **è·¯ç”±å®šä¹‰**ï¼š`app.METHOD(PATH, HANDLER)`ï¼Œæ”¯æŒåŠ¨æ€è·¯å¾„ `:id` å’ŒæŸ¥è¯¢å‚æ•° `?name=xxx`ã€‚
3. **req/res æ–¹æ³•**ï¼š`req.params`ã€`req.query` è·å–æ•°æ®ï¼Œ`res.json()`ã€`res.redirect()` å‘é€å“åº”ã€‚
4. **ä¸­é—´ä»¶æ ¸å¿ƒ**ï¼šé€šè¿‡ `next()` å½¢æˆé“¾å¼å¤„ç†ï¼Œå¯å®ç°æ—¥å¿—ã€éªŒè¯ã€è·¯ç”±æ§åˆ¶ç­‰åŠŸèƒ½ã€‚
5. **å†…ç½®ä¸­é—´ä»¶**ï¼š`express.json()` è§£æ JSONï¼Œ`express.static()` æä¾›é™æ€æ–‡ä»¶æœåŠ¡ã€‚
## è¯¾åç»ƒä¹ 

1. ï¼ˆå•é€‰ï¼‰Express ä¸­ `next()` çš„ä½œç”¨æ˜¯ï¼š
   - A. ç›´æ¥ç»“æŸå“åº”
   - B. è·³è¿‡å½“å‰ä¸­é—´ä»¶ï¼Œç»§ç»­åç»­å¤„ç†
   - C. é‡æ–°å¯åŠ¨æœåŠ¡å™¨
   - D. ä»…ç”¨äºé”™è¯¯å¤„ç†ä¸­é—´ä»¶

2. ï¼ˆå¡«ç©ºï¼‰è¦è·å– POST è¯·æ±‚çš„ JSON æ•°æ®ï¼Œéœ€åœ¨è·¯ç”±å‰æ·»åŠ ä¸­é—´ä»¶ `______`ã€‚

3. ï¼ˆç¼–ç¨‹ï¼‰ç¼–å†™ä¸€ä¸ª Express æœåŠ¡ï¼š
   - ç›‘å¬ç«¯å£ `3001`ã€‚
   - å®šä¹‰ `/api/time` è·¯ç”±ï¼Œè¿”å›å½“å‰æ—¶é—´çš„ JSON æ ¼å¼ã€‚
   - ä½¿ç”¨é™æ€æ–‡ä»¶æœåŠ¡æä¾› `public/` æ–‡ä»¶å¤¹ä¸­çš„èµ„æºã€‚

:::details å‚è€ƒç­”æ¡ˆ
1. B
2. `express.json()`
3. 
```javascript
// time-server.mjs
import express from 'express';
import path from 'node:path';

const app = express();
const __dirname = path.resolve();

// é™æ€æ–‡ä»¶æœåŠ¡
app.use(express.static(path.join(__dirname, 'public')));

// æ—¶é—´æ¥å£
app.get('/api/time', (req, res) => {
  res.json({ time: new Date().toISOString() });
});

app.listen(3001, () => {
  console.log('æœåŠ¡å¯åŠ¨åœ¨ 3001 ç«¯å£');
});
```
:::
## æ‰©å±•é˜…è¯»
- [Express è·¯ç”±æ–‡æ¡£](https://expressjs.com/zh-cn/guide/routing.html)
- [ä¸­é—´ä»¶æŒ‡å—](https://expressjs.com/zh-cn/guide/using-middleware.html)
- [é™æ€æ–‡ä»¶æœåŠ¡é…ç½®](https://expressjs.com/zh-cn/starter/static-files.html)
