# E24. ç®€å•è”ç½‘äº’åŠ¨æ¸¸æˆç¤ºä¾‹

:::warning
æœ¬èŠ‚å†…å®¹å°šæœªç»è¿‡å®¡æ ¸ï¼ä¸ä¿è¯ä»£ç èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚
:::
## 4.1. ğŸŒŸ ç³»ç»Ÿæ¶æ„è®¾è®¡

```mermaid
graph LR
    A[æµè§ˆå™¨ç«¯] --> B[Vue.js]
    B --> C[WebSocket(socket.io)]
    C --> D[Node.jsæœåŠ¡ç«¯]
    D --> E[SQLiteæ•°æ®åº“]
    E -->|å­˜å‚¨ç©å®¶æ•°æ®| D
    D -->|å®æ—¶é€šä¿¡| C
```

## 4.2. ğŸŒŸ æ ¸å¿ƒæµç¨‹è¯¦è§£

### æœåŠ¡ç«¯æµç¨‹ï¼ˆExpress+Socket.IOï¼‰
```javascript
// server.mjs
import express from 'express';
import { Server } from 'socket.io';
import sqlite3 from 'sqlite3';

// æ•°æ®åº“åˆå§‹åŒ–
const db = new sqlite3.Database('players.db');
db.serialize(() => {
  db.run('CREATE TABLE IF NOT EXISTS players (id TEXT PRIMARY KEY, score INTEGER, high_score INTEGER)');
});

const app = express();
const httpServer = app.listen(3000);
const io = new Server(httpServer);

// ç©å®¶å®æ—¶æ•°æ®å­˜å‚¨
const players = new Map();

// æ¯è½®æ¸¸æˆçŠ¶æ€
let gameInterval = null;
let currentRoundPlayers = new Map();

// æ¯5ç§’ä¸€è½®
function startGameCycle() {
  gameInterval = setInterval(() => {
    // 1. æ¸…ç©ºå½“å‰è½®æ¬¡æ•°æ®
    currentRoundPlayers.clear();

    // 2. å¹¿æ’­æ¸¸æˆå¼€å§‹
    io.emit('game-start', { timeLeft: 5 });

    // 3. 5ç§’åç»“æŸæœ¬è½®
    setTimeout(() => {
      // è®¡ç®—å¾—åˆ†
      calculateScores();
      // é‡ç½®æ•°æ®
      currentRoundPlayers.clear();
      // å¹¿æ’­ç»“æœ
      io.emit('round-end', { scores: Array.from(players.values()) });
    }, 5000);
  }, 5000);
}

// è¿æ¥äº‹ä»¶
io.on('connection', (socket) => {
  socket.on('join', (playerId) => {
    // åˆå§‹åŒ–ç©å®¶æ•°æ®
    db.get('SELECT * FROM players WHERE id = ?', [playerId], (err, row) => {
      if (row) {
        players.set(playerId, { id: playerId, score: row.score || 0, high_score: row.high_score || 0 });
      } else {
        players.set(playerId, { id: playerId, score: 0, high_score: 0 });
        db.run('INSERT INTO players (id, score, high_score) VALUES (?, 0, 0)', [playerId]);
      }
      socket.emit('player-joined', players.get(playerId));
    });
  });

  socket.on('submit-number', (data) => {
    const { playerId, number } = data;
    if (!currentRoundPlayers.has(playerId)) {
      currentRoundPlayers.set(playerId, number);
    }
  });

  socket.on('disconnect', () => {
    // æ–­å¼€æ—¶ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“
    players.forEach((player) => {
      db.run('UPDATE players SET score = ?, high_score = ? WHERE id = ?', 
        [player.score, player.high_score, player.id]);
    });
  });
});

startGameCycle();
```
## 4.3. ğŸŒŸ å‰ç«¯å®ç°ï¼ˆVue.jsï¼‰

```vue
<!-- Game.vue -->
<template>
  <div class="game-container">
    <h1>å®æ—¶äº’åŠ¨æ¸¸æˆ</h1>
    <div v-if="gameState === 'waiting'">
      <p>æ¸¸æˆå³å°†å¼€å§‹ï¼Œè¯·å‡†å¤‡...</p>
    </div>
    <div v-else-if="gameState === 'active'">
      <p>å‰©ä½™æ—¶é—´ï¼š{{ timeLeft }} ç§’</p>
      <div class="number-input">
        <input v-model.number="selectedNumber" type="number" min="1" max="5">
        <button @click="submitNumber">æäº¤</button>
      </div>
    </div>
    <div v-else-if="gameState === 'result'">
      <p>æœ¬è½®ç»“æœï¼š</p>
      <ul>
        <li v-for="player in players" :key="player.id">
          {{ player.id.substr(0,5) }}: {{ player.score }} åˆ†
        </li>
      </ul>
    </div>
    <div>
      <p>å½“å‰åˆ†æ•°ï¼š{{ myScore }}</p>
      <p>å†å²æœ€é«˜åˆ†ï¼š{{ myHighScore }}</p>
    </div>
  </div>
</template>

<script>
import { io } from 'socket.io-client';

export default {
  data() {
    return {
      playerId: localStorage.getItem('playerId') || this.generateId(),
      socket: null,
      gameState: 'waiting',
      timeLeft: 0,
      selectedNumber: null,
      players: [],
      myScore: 0,
      myHighScore: 0
    };
  },
  mounted() {
    this.socket = io('http://localhost:3000');

    this.socket.emit('join', this.playerId);

    this.socket.on('game-start', (data) => {
      this.gameState = 'active';
      this.timeLeft = data.timeLeft;
      this.countdown = setInterval(() => {
        this.timeLeft--;
        if (this.timeLeft <= 0) clearInterval(this.countdown);
      }, 1000);
    });

    this.socket.on('round-end', (data) => {
      this.gameState = 'result';
      this.players = data.scores;
      this.myScore = this.players.find(p => p.id === this.playerId).score;
      this.myHighScore = Math.max(this.myScore, this.players.find(p => p.id === this.playerId).high_score);
      setTimeout(() => this.gameState = 'waiting', 3000);
    });
  },
  methods: {
    generateId() {
      const nanoid = require('nanoid');
      const id = nanoid(10);
      localStorage.setItem('playerId', id);
      return id;
    },
    submitNumber() {
      if (this.selectedNumber >= 1 && this.selectedNumber <= 5) {
        this.socket.emit('submit-number', { playerId: this.playerId, number: this.selectedNumber });
        this.selectedNumber = null;
      }
    }
  }
};
</script>
```
## 4.4. ğŸŒŸ å…³é”®ç®—æ³•å®ç°

### åˆ†æ•°è®¡ç®—é€»è¾‘
```javascript
function calculateScores() {
  const roundPlayers = Array.from(currentRoundPlayers.entries());

  // éå†æ‰€æœ‰ç©å®¶å¯¹
  roundPlayers.forEach(([playerAId, playerANum]) => {
    roundPlayers.forEach(([playerBId, playerBNum]) => {
      if (playerAId !== playerBId) {
        // å¾ªç¯æ¯”è¾ƒï¼š5æ¯”1å°1ï¼Œ1æ¯”5å°1ï¼Ÿ
        const diff = (playerBNum - playerANum + 5) % 5;
        if (diff === 4) { // å½“å·®å€¼ä¸º4æ—¶ï¼Œè¯´æ˜Bæ¯”Aå°1ï¼ˆ5-1=4ï¼‰
          // Bçš„æ•°å­—æ¯”Aå°1
          const playerA = players.get(playerAId);
          const playerB = players.get(playerBId);
          playerA.score += 1;
          playerB.score -= 1;
          updateHighScore(playerA);
          updateHighScore(playerB);
        }
      }
    });
  });
}

function updateHighScore(player) {
  if (player.score > player.high_score) {
    player.high_score = player.score;
  }
}
```
## 4.5. âš ï¸ å…³é”®ç‚¹è¯´æ˜

### 4.5.1. ç©å®¶IDç”Ÿæˆä¸å­˜å‚¨
```javascript
// ä½¿ç”¨ nanoid ç”Ÿæˆå”¯ä¸€ID
const nanoid = require('nanoid');
const playerId = nanoid(10);
localStorage.setItem('playerId', playerId);
```

### 4.5.2. å¾ªç¯æ¯”è¾ƒé€»è¾‘
```javascript
// ç¤ºä¾‹ï¼š5ä¸1çš„æ¯”è¾ƒ
const a = 5, b = 1;
const diff = (b - a + 5) % 5; // (1-5+5)%5 = 1 â†’ ä¸æ»¡è¶³æ¡ä»¶ï¼Ÿ
// éœ€è¦è°ƒæ•´å…¬å¼ï¼š
// æ­£ç¡®å…¬å¼åº”ä¸ºï¼š(playerANum - playerBNum + 5) % 5 === 1
// å½“ Aé€‰5ï¼ŒBé€‰1 â†’ (5-1) mod5=4 â†’ ä¸æ»¡è¶³
// æ­£ç¡®åˆ¤æ–­åº”ä¸ºï¼šå½“ (playerBNum === playerANum -1) || (playerANum ===5 && playerBNum ===1)
// å› æ­¤éœ€è¦é‡æ–°è®¾è®¡æ¯”è¾ƒé€»è¾‘ï¼š
if ( (playerBNum === playerANum -1) || 
     (playerANum ===5 && playerBNum ===1) ) {
  // Bæ¯”Aå°1
}
```

### 4.5.3. æ•°æ®åº“æŒä¹…åŒ–
```javascript
// ç©å®¶è¿æ¥æ—¶åˆå§‹åŒ–æ•°æ®
db.get('SELECT * FROM players WHERE id = ?', [playerId], (err, row) => {
  if (!row) {
    db.run('INSERT INTO players (id, score, high_score) VALUES (?,0,0)', [playerId]);
  }
});

// æ–­å¼€æ—¶ä¿å­˜æ•°æ®
socket.on('disconnect', () => {
  players.forEach((player) => {
    db.run('UPDATE players SET score=?, high_score=? WHERE id=?',
      [player.score, player.high_score, player.id]);
  });
});
```
## 4.6. ğŸŒŸ å®Œæ•´å¼€å‘æ­¥éª¤

### æœåŠ¡ç«¯éƒ¨ç½²
```bash
# å®‰è£…ä¾èµ–
npm install express socket.io sqlite3 nanoid

# åˆå§‹åŒ–æ•°æ®åº“
node -e "const sqlite3 = require('sqlite3'); 
         new sqlite3.Database('players.db', 
           db => db.serialize(() => 
             db.run('CREATE TABLE IF NOT EXISTS players (id TEXT PRIMARY KEY, score INTEGER, high_score INTEGER)')))"

# å¯åŠ¨æœåŠ¡
node server.mjs
```

### å‰ç«¯é…ç½®
```bash
# åˆ›å»ºVueé¡¹ç›®
vue create game-project
cd game-project

# å®‰è£…ä¾èµ–
npm install socket.io-client nanoid
```

```javascript
// vue.config.js
module.exports = {
  devServer: {
    proxy: {
      '/': {
        target: 'http://localhost:3000',
        changeOrigin: true,
        pathRewrite: { '^/': '' }
      }
    }
  }
}
```

é…ç½®vue.config.jsï¼ˆå…è®¸è·¨åŸŸï¼‰

## çŸ¥è¯†å›é¡¾

1. **å®æ—¶é€šä¿¡**ï¼šé€šè¿‡ socket.io å®ç°ç©å®¶é—´çš„æ•°æ®åŒæ­¥ï¼Œæ¯5ç§’ä¸€è½®ã€‚
2. **åˆ†æ•°è®¡ç®—**ï¼šé‡‡ç”¨å¾ªç¯æ¯”è¾ƒé€»è¾‘ï¼Œç¡®ä¿5å’Œ1çš„ç‰¹æ®Šå…³ç³»ã€‚
3. **æ•°æ®æŒä¹…åŒ–**ï¼šSQLite å­˜å‚¨ç©å®¶IDã€å½“å‰åˆ†æ•°å’Œå†å²æœ€é«˜åˆ†ã€‚
4. **ç”¨æˆ·ä½“éªŒ**ï¼šé€šè¿‡ Vue å®ç°åŠ¨æ€ç•Œé¢ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶ã€ç©å®¶åˆ†æ•°ç­‰å®æ—¶æ•°æ®ã€‚
5. **é˜²ä½œå¼Šæœºåˆ¶**ï¼šç©å®¶IDé€šè¿‡ localStorage å­˜å‚¨ï¼Œä½†éœ€æ³¨æ„å®‰å…¨æ€§ï¼ˆå¯æ‰©å±•åŠ å¯†å­˜å‚¨ï¼‰ã€‚
## è¯¾åç»ƒä¹ 

1. ï¼ˆç¼–ç¨‹ï¼‰å®ç°ã€Œå†å²æœ€é«˜åˆ†ã€åŠŸèƒ½ï¼Œç¡®ä¿æ¯æ¬¡å¾—åˆ†æ›´æ–°æ—¶è‡ªåŠ¨è®°å½•æœ€é«˜åˆ†ã€‚
2. ï¼ˆä¼˜åŒ–ï¼‰æ·»åŠ ã€Œç©å®¶æ’è¡Œæ¦œã€åŠŸèƒ½ï¼Œå®æ—¶æ˜¾ç¤ºå‰10åç©å®¶ã€‚
3. ï¼ˆæ‰©å±•ï¼‰å®ç°ã€Œå›åˆé‡ç½®ã€åŠŸèƒ½ï¼Œå…è®¸ç©å®¶æ‰‹åŠ¨é‡ç½®å½“å‰åˆ†æ•°ã€‚

:::details å‚è€ƒç­”æ¡ˆï¼ˆé—®é¢˜1ï¼‰
```javascript
// åœ¨ calculateScores() ä¸­æ·»åŠ ï¼š
function updateHighScore(player) {
  if (player.score > player.high_score) {
    player.high_score = player.score;
    db.run('UPDATE players SET high_score=? WHERE id=?', 
           [player.high_score, player.id]);
  }
}
```
:::
