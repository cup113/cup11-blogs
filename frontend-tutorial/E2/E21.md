# E21. Node.js åŸºç¡€

## 1.1. ğŸŒŸ Node.js ç¯å¢ƒä¸ REPL äº¤äº’å¼è°ƒè¯•

> Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œæ”¯æŒç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ JavaScript ä»£ç ã€‚é€šè¿‡ REPLï¼ˆäº¤äº’å¼è§£é‡Šå™¨ï¼‰å¯ä»¥å¿«é€ŸéªŒè¯ä»£ç é€»è¾‘ã€‚

### å¯åŠ¨ REPL ç¯å¢ƒ
```bash
node
```

### REPL åŸºç¡€æ“ä½œ
```javascript
// ç¤ºä¾‹ï¼šæ‰§è¡Œç®€å•è®¡ç®—
> 1 + 2 + 3
6

// å£°æ˜å˜é‡ï¼ˆéœ€ä½¿ç”¨ var/let/constï¼‰
> let name = 'Node.js'
undefined
> console.log(name)
Node.js

// å¤šè¡Œè¾“å…¥ï¼ˆè‡ªåŠ¨è¯†åˆ«ä»£ç å—ï¼‰
> if (true) {
...   console.log('å¤šè¡Œè¾“å…¥');
... }
å¤šè¡Œè¾“å…¥

// ç‰¹æ®Šå‘½ä»¤
> .help  // æŸ¥çœ‹å‘½ä»¤åˆ—è¡¨
> .exit  // é€€å‡º REPL
```

:::tip
- ä½¿ç”¨ `Ctrl+C` é€€å‡ºå½“å‰æ“ä½œï¼Œ`Ctrl+D` é€€å‡º REPLã€‚
- è¾“å…¥ `_.toString()` å¯æŸ¥çœ‹ä¸Šä¸€ä¸ªè¡¨è¾¾å¼ç»“æœçš„è¯¦ç»†ä¿¡æ¯ã€‚
:::
## 1.2. ğŸŒŸ Node.js éµå¾ª ES è§„èŒƒä½†ä¸å…·å¤‡ Web API

> Node.js æ”¯æŒç°ä»£ JavaScriptï¼ˆESï¼‰è¯­æ³•ï¼Œä½†ç¼ºå°‘æµè§ˆå™¨æä¾›çš„ Web APIï¼ˆå¦‚ DOMã€BOMï¼‰ã€‚

### ES è§„èŒƒæ”¯æŒ
```javascript
// ES6+ è¯­æ³•ç¤ºä¾‹ï¼ˆéœ€ä½¿ç”¨ .mjs æ–‡ä»¶æ‰©å±•åï¼‰
// demo.mjs
import { sqrt } from 'mathjs';
console.log(sqrt(16)); // è¾“å‡º 4
```

### Web API ç¼ºå¤±åœºæ™¯
```javascript
// ä»¥ä¸‹ä»£ç åœ¨ Node.js ä¸­æ— æ³•è¿è¡Œ
// windowã€documentã€navigator ç­‰å…¨å±€å¯¹è±¡ä¸å­˜åœ¨
console.log(window.innerWidth); // æŠ¥é”™
```

:::warning
Node.js ç¯å¢ƒçš„å…¨å±€å¯¹è±¡æ˜¯ `global`ï¼Œè€Œéæµè§ˆå™¨çš„ `window`ã€‚
:::
## 1.3. ğŸŒŸ util æ¨¡å—ï¼šå¼¥è¡¥ Web API çš„ç¼ºå¤±

> `util` æ¨¡å—æä¾›å·¥å…·å‡½æ•°ï¼Œå¸®åŠ©å¤„ç† Node.js ç¯å¢ƒä¸­çš„å¸¸è§éœ€æ±‚ï¼ˆå¦‚æ—¥å¿—æ ¼å¼åŒ–ã€ç±»å‹æ£€æŸ¥ï¼‰ã€‚

### å¸¸ç”¨åŠŸèƒ½ç¤ºä¾‹
```javascript
// util.mjs
import util from 'util';

// 1. æ£€æŸ¥æ•°æ®ç±»å‹
console.log(util.types.isNumber(42)); // true

// 2. è½¬æ¢æµä¸º Promise
const stream = { ... };
const promisified = util.promisify(stream.read);
```

### æ—¥å¿—å¢å¼ºç¤ºä¾‹
```javascript
// ä½¿ç”¨ util.inspect æ ¼å¼åŒ–è¾“å‡ºå¤æ‚å¯¹è±¡
const obj = { a: 1, b: { c: 2 } };
console.log(util.inspect(obj, { depth: null }));
```
## 1.4. ğŸŒŸ path å’Œ fs æ¨¡å—ï¼šæ–‡ä»¶ç³»ç»Ÿæ“ä½œ

> `path` å¤„ç†æ–‡ä»¶è·¯å¾„ï¼Œ`fs` æ“ä½œæ–‡ä»¶ç³»ç»Ÿï¼Œä¸¤è€…ååŒå®Œæˆæ–‡ä»¶è¯»å†™ã€‚

### path æ¨¡å—ï¼šè·¯å¾„å¤„ç†
```javascript
// path-example.mjs
import path from 'node:path';

const filePath = path.join(__dirname, 'data', 'file.txt');
console.log(path.basename(filePath)); // è¾“å‡º 'file.txt'
```

### fs æ¨¡å—ï¼šå¼‚æ­¥æ–‡ä»¶è¯»å†™
```javascript
// fs-example.mjs
import fs from 'node:fs';

// å¼‚æ­¥è¯»å–æ–‡ä»¶
fs.promises.readFile('file.txt', 'utf-8')
  .then(data => console.log(data))
  .catch(err => console.error(err));

// åŒæ­¥å†™å…¥æ–‡ä»¶ï¼ˆæ…ç”¨é˜»å¡æ“ä½œï¼‰
fs.writeFileSync('output.txt', 'Hello Node.js');
```

:::details ä¾‹ï¼šåˆ›å»ºç›®å½•å¹¶å†™å…¥æ–‡ä»¶
```javascript
import { mkdir, writeFile } from 'node:fs/promises';
import path from 'node:path';

const dirPath = path.join(__dirname, 'new_dir');
await mkdir(dirPath, { recursive: true });
await writeFile(path.join(dirPath, 'test.txt'), 'å†…å®¹');
```
:::
## 1.5. ğŸŒŸ process æ¨¡å—ï¼šè¿›ç¨‹ç®¡ç†ä¸ç¯å¢ƒå˜é‡

> `process` æ¨¡å—æä¾›å¯¹ Node.js è¿›ç¨‹çš„æ§åˆ¶ï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡ã€å†…å­˜ç›‘æ§ç­‰ã€‚

### ç¯å¢ƒå˜é‡æ“ä½œ
```javascript
// è·å–ç¯å¢ƒå˜é‡
console.log(process.env.NODE_ENV); // è¾“å‡º 'development'

// è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä»…å½“å‰è¿›ç¨‹æœ‰æ•ˆï¼‰
process.env.MY_VAR = 'test';
```

### è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
```javascript
// ç›‘å¬è¿›ç¨‹é€€å‡ºäº‹ä»¶
process.on('exit', (code) => {
  console.log(`è¿›ç¨‹é€€å‡ºï¼ŒçŠ¶æ€ç  ${code}`);
});

// ä¸»åŠ¨ç»ˆæ­¢è¿›ç¨‹
process.exit(1); // ä¼ å…¥é€€å‡ºç 
```
## çŸ¥è¯†å›é¡¾

1. **REPL æ ¸å¿ƒæ“ä½œ**ï¼šå¯åŠ¨ã€å¤šè¡Œè¾“å…¥ã€ç‰¹æ®Šå‘½ä»¤ï¼ˆ`.exit`ã€`.help`ï¼‰ã€‚
2. **ES è§„èŒƒå·®å¼‚**ï¼šNode.js æ”¯æŒ ES è¯­æ³•ï¼Œä½†ç¼ºå°‘ Web APIã€‚
3. **util æ¨¡å—åŠŸèƒ½**ï¼šç±»å‹æ£€æŸ¥ã€æ—¥å¿—æ ¼å¼åŒ–ã€Promise è½¬æ¢ã€‚
4. **æ–‡ä»¶æ“ä½œæµç¨‹**ï¼š`path` å¤„ç†è·¯å¾„ï¼Œ`fs` è¯»å†™æ–‡ä»¶ï¼Œéœ€æ³¨æ„å¼‚æ­¥/åŒæ­¥å·®å¼‚ã€‚
5. **process æ¨¡å—ä½œç”¨**ï¼šç®¡ç†ç¯å¢ƒå˜é‡ã€ç›‘å¬è¿›ç¨‹äº‹ä»¶ã€æ§åˆ¶è¿›ç¨‹é€€å‡ºã€‚
## è¯¾åç»ƒä¹ 

1. ï¼ˆå•é€‰ï¼‰åœ¨ Node.js REPL ä¸­ï¼Œå¦‚ä½•é€€å‡ºå½“å‰å¤šè¡Œè¾“å…¥ï¼Ÿ
   - A. æŒ‰ä¸¤æ¬¡ `Ctrl+C`
   - B. è¾“å…¥ `.break`
   - C. è¾“å…¥ `.exit`
   - D. æŒ‰ `Enter`

2. ï¼ˆå¡«ç©ºï¼‰ä½¿ç”¨ `path` æ¨¡å—æ‹¼æ¥è·¯å¾„æ—¶ï¼Œåº”è°ƒç”¨çš„é™æ€æ–¹æ³•æ˜¯ `______`ã€‚

3. ï¼ˆç¼–ç¨‹ï¼‰ç¼–å†™ä¸€ä¸ª `.mjs` æ–‡ä»¶ï¼Œå®Œæˆä»¥ä¸‹æ“ä½œï¼š
   - è¯»å– `input.txt` æ–‡ä»¶å†…å®¹ã€‚
   - å°†å†…å®¹åè½¬åå†™å…¥ `output.txt`ã€‚

:::details å‚è€ƒç­”æ¡ˆ
1. B
2. `path.join`
3. 
```javascript
// reverse.mjs
import fs from 'node:fs/promises';
import path from 'node:path';

const inputPath = path.resolve('input.txt');
const outputPath = path.resolve('output.txt');

async function processFile() {
  const data = await fs.readFile(inputPath, 'utf-8');
  await fs.writeFile(outputPath, data.split('').reverse().join(''));
}

processFile().catch(console.error);
```
:::
## æ‰©å±•é˜…è¯»
- [Node.js REPL å®˜æ–¹æ–‡æ¡£](https://nodejs.org/api/repl.html)
- [util æ¨¡å— API å‚è€ƒ](https://nodejs.org/api/util.html)
- [æ–‡ä»¶ç³»ç»Ÿæ¨¡å—æŒ‡å—](https://nodejs.org/api/fs.html)
