# D24. ä½¿ç”¨ JavaScript è¿›è¡Œè¿è¡Œæ—¶ç±»å‹éªŒè¯

## 4.1. ğŸŒŸ **TypeScript çš„é™æ€ç±»å‹å±€é™ä¸è¿è¡Œæ—¶éªŒè¯å¿…è¦æ€§**

### 4.1.1. é™æ€ç±»å‹ä¸è¿è¡Œæ—¶çš„é¸¿æ²Ÿ

**æ ¸å¿ƒæ€æƒ³**ï¼š
TypeScript çš„ç±»å‹æ£€æŸ¥ä»…åœ¨ç¼–è¯‘æ—¶ç”Ÿæ•ˆï¼Œ**è¿è¡Œæ—¶æ•°æ®å¯èƒ½å› å¤–éƒ¨è¾“å…¥æˆ–åŠ¨æ€æ“ä½œç ´åç±»å‹å®‰å…¨**ã€‚

**ç¤ºä¾‹ï¼šTypeScript çš„é™æ€ç±»å‹å¤±æ•ˆåœºæ™¯**
```typescript
class People {
  name: string;
  age: number;

  constructor(people: string) {
    const parsed = JSON.parse(people);
    this.name = parsed.name;
    this.age = parsed.age;
  }
}

// ç¼–è¯‘é€šè¿‡ï¼Œä½†è¿è¡Œæ—¶å‡ºé”™
const person = new People("{ name: 123, age: 12 }"); // name è¢«è®¾ç½®ä¸ºäº†æ•°å­—
```

**é—®é¢˜æ ¹æº**ï¼š
- **åŠ¨æ€è¾“å…¥**ï¼šç”¨æˆ·è¾“å…¥ã€ç¬¬ä¸‰æ–¹ APIã€æ–‡ä»¶è¯»å–ç­‰å¤–éƒ¨æ•°æ®å¯èƒ½è¿åç±»å‹å®šä¹‰ã€‚
- **ç±»å‹æ“¦é™¤**ï¼šTypeScript ç¼–è¯‘åç”Ÿæˆçš„ JavaScript ä»£ç ä¸ä¿ç•™ç±»å‹ä¿¡æ¯ã€‚

### 4.1.2. ç°å®åœºæ™¯ä¸­çš„ç±»å‹æ¼æ´ç¤ºä¾‹

**åœºæ™¯ 1ï¼šç”¨æˆ·è¡¨å•æäº¤**
```typescript
// è¡¨å•æ•°æ®å¯èƒ½åŒ…å«éæ•°å­—çš„ age
interface UserForm {
  name: string;
  age: number;
}

function processForm(data: UserForm) {
  console.log(`Age is ${data.age * 2}`); // è‹¥ age æ˜¯å­—ç¬¦ä¸²ï¼Œä¼šéšå¼è½¬æ¢å¯¼è‡´é”™è¯¯
}

// å‡è®¾å‰ç«¯æäº¤çš„æ•°æ®ï¼š{ name: "Alice", age: "twenty" }
processForm({ name: "Alice", age: "twenty" }); // è¿è¡Œæ—¶è®¡ç®—å¤±è´¥
```

**åœºæ™¯ 2ï¼šç¬¬ä¸‰æ–¹ API æ•°æ®**
```typescript
interface ApiResponse {
  id: number;
  content: string[];
}

// API è¿”å›çš„æ•°æ®å¯èƒ½åŒ…å«æœªå®šä¹‰çš„å­—æ®µæˆ–ç±»å‹é”™è¯¯
const response = await fetch("/api/data").then(res => res.json());
// è‹¥ response.content æ˜¯å­—ç¬¦ä¸²è€Œéæ•°ç»„ï¼Œåç»­ä»£ç ä¼šå´©æºƒ
response.content.forEach(item => console.log(item));
```

## 4.2. ğŸŒŸ **zodï¼šç°ä»£è¿è¡Œæ—¶ç±»å‹éªŒè¯æ ‡å‡†åº“**

### 4.2.1. zod æ ¸å¿ƒæ¦‚å¿µï¼šæ¨¡å¼ï¼ˆSchemaï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼š
é€šè¿‡å®šä¹‰ `zod.Schema` æè¿°æ•°æ®ç»“æ„ï¼Œå®ç°**è¿è¡Œæ—¶æ ¡éªŒä¸ç±»å‹è½¬æ¢**ã€‚

**å®‰è£…ä¸åŸºç¡€ç”¨æ³•**
```bash
npm install zod
```

**å®šä¹‰å¯¹è±¡éªŒè¯æ¨¡å¼**
```typescript
import { z } from "zod";

const userSchema = z.object({
  name: z.string().min(3),
  age: z.number().int().positive(),
  isAdmin: z.boolean().optional(),
});

// éªŒè¯æ•°æ®å¹¶è½¬æ¢ä¸ºç±»å‹å®‰å…¨çš„å€¼
try {
  const data = userSchema.parse({
    name: "John",
    age: "25", // âŒ ç±»å‹é”™è¯¯ï¼šå­—ç¬¦ä¸²è½¬æ•°å­—å¤±è´¥
  });
} catch (err) {
  console.error((err as z.ZodError).errors); // è¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
}
```

### 4.2.2. åŸºç¡€éªŒè¯ï¼šå¯¹è±¡ã€æ•°ç»„ã€è‡ªå®šä¹‰ç±»å‹

**éªŒè¯åµŒå¥—å¯¹è±¡**
```typescript
const addressSchema = z.object({
  street: z.string(),
  city: z.string(),
});

const userSchema = z.object({
  name: z.string(),
  addresses: z.array(addressSchema).min(1),
});
```

**è‡ªå®šä¹‰è”åˆç±»å‹**
```typescript
const paymentMethodSchema = z.union([
  z.literal("credit_card"),
  z.literal("paypal"),
]);
```

**ç±»å‹æ¨æ–­**
```typescript
type User = z.infer<typeof userSchema>; // è‡ªåŠ¨æ¨å¯¼ç±»å‹
```

### 4.2.3. é”™è¯¯å¤„ç†ä¸ç±»å‹è½¬æ¢

**ä¼˜é›…çš„é”™è¯¯å¤„ç†**
```typescript
function validateUser(data: any) {
  try {
    return userSchema.parse(data);
  } catch (err) {
    const errors = (err as z.ZodError).flatten().fieldErrors;
    throw new Error(`Validation failed: ${JSON.stringify(errors)}`);
  }
}
```

**ç±»å‹è½¬æ¢ï¼ˆCoercionï¼‰**
```typescript
const numberSchema = z.string().transform(str => parseInt(str, 10));
numberSchema.parse("42"); // æˆåŠŸï¼Œè¿”å›æ•°å­— 42
```

## 4.3. ğŸŒŸ **valibotï¼šè½»é‡çº§é«˜æ€§èƒ½éªŒè¯æ–¹æ¡ˆ**

### 4.3.1. valibot çš„æ ¸å¿ƒä¼˜åŠ¿ï¼šé›¶ç±»å‹æ³¨è§£

**æ ¸å¿ƒæ€æƒ³**ï¼š
é€šè¿‡**çº¯å‡½æ•°å¼ API** å®šä¹‰éªŒè¯è§„åˆ™ï¼Œ**æ— éœ€ TypeScript ç±»å‹æ³¨è§£**ï¼ŒéªŒè¯å™¨å¯ç‹¬ç«‹äºç±»å‹ç³»ç»Ÿå­˜åœ¨ã€‚

**å®‰è£…ä¸åŸºç¡€ç”¨æ³•**
```bash
npm install valibot
```

**å®šä¹‰éªŒè¯è§„åˆ™**
```typescript
import { object, string, number, optional } from "valibot";

const userValidator = object({
  name: string(),
  age: number(),
  isAdmin: optional(number()), // å…è®¸çœç•¥æˆ–æ•°å­—
});

// éªŒè¯æ•°æ®
const result = validate(userValidator, { name: "Alice", age: 25 });
// result: { valid: true, value: { name: "Alice", age: 25 } }
```

### 4.3.2. ä¸ zod çš„å¯¹æ¯”ï¼šAPI ç®€æ´æ€§ä¸æ€§èƒ½

**API å¯¹æ¯”**
```typescript
// zod
z.object({ name: z.string().min(3) });

// valibot
object({ name: string().min(3) }); // æ›´ç®€æ´çš„é“¾å¼è°ƒç”¨
```

**æ€§èƒ½ä¼˜åŠ¿**
- **é›¶ç±»å‹æ³¨è§£**ï¼šéªŒè¯å™¨ä¸ TypeScript ç±»å‹è§£è€¦ï¼Œé€‚åˆé TypeScript é¡¹ç›®ã€‚
- **æ›´å°ä½“ç§¯**ï¼švalibot çš„å‹ç¼©åä½“ç§¯çº¦ **1KB**ï¼Œzod çº¦ **8KB**ã€‚

### 4.3.3. å®Œæ•´éªŒè¯æµç¨‹ç¤ºä¾‹

**éªŒè¯å¤æ‚ç»“æ„**
```typescript
import {
  object,
  array,
  string,
  number,
  literal,
  union
} from "valibot";

const paymentMethod = union([literal("credit_card"), literal("paypal")]);

const orderValidator = object({
  id: string().length(36), // UUID æ ¡éªŒ
  items: array(
    object({
      productId: string(),
      quantity: number().min(1),
    })
  ),
  paymentMethod: paymentMethod,
});

// éªŒè¯å¹¶è·å–å®‰å…¨æ•°æ®
const order = validate(orderValidator, rawOrderData);
if (order.valid) {
  processOrder(order.value);
} else {
  console.error(order.errors);
}
```

## 4.4. ğŸŒŸ **JSON è¾“å…¥çš„ç±»å‹å®‰å…¨é˜²æŠ¤**

### 4.4.1. å‰åç«¯æ•°æ®äº¤äº’çš„ç±»å‹æ–­å±‚

**æ ¸å¿ƒé—®é¢˜**ï¼š
å³ä½¿åç«¯ä¸¥æ ¼éªŒè¯æ•°æ®ï¼Œ**å‰ç«¯ä»éœ€äºŒæ¬¡éªŒè¯**ä»¥é˜²å¾¡ï¼š
- ç½‘ç»œåŠ«æŒå¯¼è‡´çš„æ•°æ®ç¯¡æ”¹
- ä¸åŒå‰ç«¯å®¢æˆ·ç«¯çš„å…¼å®¹æ€§é—®é¢˜
- å¼€å‘é˜¶æ®µçš„ API ç‰ˆæœ¬å·®å¼‚

### 4.4.2. éªŒè¯ JSON æ•°æ®çš„å…¸å‹åœºæ™¯

**åœºæ™¯ 1ï¼šè§£æ HTTP å“åº”**
```typescript
// ä½¿ç”¨ zod éªŒè¯ API å“åº”
const apiResponseSchema = z.object({
  status: z.number(),
  data: z.array(z.object({ id: z.string() })),
});

try {
  const response = await fetch("/api/data");
  const data = apiResponseSchema.parse(await response.json());
  // å®‰å…¨ä½¿ç”¨ data
} catch (err) {
  // å¤„ç†éªŒè¯å¤±è´¥
}
```

**åœºæ™¯ 2ï¼šè¯»å–æœ¬åœ°å­˜å‚¨æ•°æ®**
```typescript
// ä½¿ç”¨ valibot éªŒè¯ localStorage æ•°æ®
const storedData = localStorage.getItem("user");
const userValidator = object({ name: string(), age: number() });

if (storedData) {
  const result = validate(userValidator, JSON.parse(storedData));
  if (result.valid) {
    // å®‰å…¨æ¢å¤ç”¨æˆ·å¯¹è±¡
  }
}
```

### 4.4.3. ä¸ REST API ç»“åˆçš„æœ€ä½³å®è·µ

**å®Œæ•´æµç¨‹ï¼šä»å®šä¹‰åˆ°éªŒè¯**
```typescript
// 1. å®šä¹‰ API å“åº”æ¨¡å¼ï¼ˆzodï¼‰
const postSchema = z.object({
  id: z.string(),
  title: z.string(),
  content: z.string(),
  comments: z.array(
    z.object({
      author: z.string(),
      text: z.string(),
    })
  ),
});

// 2. å°è£…è¯·æ±‚å‡½æ•°
async function fetchPost(id: string) {
  const response = await fetch(`/api/posts/${id}`);
  const raw = await response.json();
  return postSchema.parse(raw); // å¼ºåˆ¶ç±»å‹å®‰å…¨
}

// 3. å®‰å…¨ä½¿ç”¨æ•°æ®
const post = await fetchPost("123");
post.comments.forEach(comment => {
  // ç±»å‹æ¨æ–­ä¸º { author: string, text: string }
});
```

## çŸ¥è¯†å›é¡¾

1. **TypeScript çš„é™æ€å±€é™æ€§**
   - ç±»å‹æ£€æŸ¥ä»…åœ¨ç¼–è¯‘æ—¶ç”Ÿæ•ˆï¼Œè¿è¡Œæ—¶æ•°æ®å¯èƒ½å› å¤–éƒ¨è¾“å…¥å¯¼è‡´ç±»å‹é”™è¯¯ã€‚
   - éœ€ç»“åˆè¿è¡Œæ—¶åº“é˜²å¾¡åŠ¨æ€æ•°æ®é£é™©ã€‚

2. **zod æ ¸å¿ƒèƒ½åŠ›**
   - é€šè¿‡ `Schema` å®šä¹‰éªŒè¯è§„åˆ™ï¼Œæ”¯æŒå¤æ‚ç±»å‹ä¸ç±»å‹æ¨æ–­ã€‚
   - æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œç±»å‹è½¬æ¢åŠŸèƒ½ã€‚

3. **valibot çš„ä¼˜åŠ¿**
   - å‡½æ•°å¼ API è®¾è®¡ï¼Œé›¶ç±»å‹æ³¨è§£éœ€æ±‚ï¼Œä½“ç§¯æ›´å°ã€‚
   - é€‚åˆå¯¹æ€§èƒ½æ•æ„Ÿæˆ–é TypeScript é¡¹ç›®ã€‚

4. **JSON è¾“å…¥é˜²æŠ¤**
   - å¯¹æ‰€æœ‰å¤–éƒ¨æ•°æ®ï¼ˆAPIã€å­˜å‚¨ï¼‰è¿›è¡Œè¿è¡Œæ—¶éªŒè¯ï¼Œé¿å…ç±»å‹æ–­å±‚ã€‚
   - ä¸é™æ€ç±»å‹ç³»ç»Ÿç»“åˆä½¿ç”¨ï¼Œæ„å»ºå¤šå±‚é˜²å¾¡ä½“ç³»ã€‚

## è¯¾åç»ƒä¹ 

1. **ï¼ˆå•é€‰ï¼‰ä»¥ä¸‹å“ªç§è¯´æ³•æ­£ç¡®ï¼Ÿ**
   - A. TypeScript çš„ç±»å‹æ£€æŸ¥åœ¨è¿è¡Œæ—¶ä»ä¼šç”Ÿæ•ˆã€‚
   - B. zod éªŒè¯å¤±è´¥æ—¶ä¼šç›´æ¥æŠ›å‡ºç±»å‹å®‰å…¨çš„é”™è¯¯å¯¹è±¡ã€‚
   - C. valibot éœ€è¦ä¾èµ– TypeScript ç±»å‹æ³¨è§£ã€‚
   - D. è¿è¡Œæ—¶éªŒè¯ä»…ç”¨äºå‰ç«¯ï¼Œåç«¯æ— éœ€å¤„ç†ã€‚

2. **ï¼ˆç¼–ç ï¼‰ä½¿ç”¨ zod å®šä¹‰ä»¥ä¸‹æ¥å£çš„éªŒè¯æ¨¡å¼ï¼š**
   ```typescript
   interface Product {
     id: string; // UUID æ ¼å¼
     price: number; // å¿…é¡» â‰¥ 0.01
     tags: string[]; // æ¯ä¸ªæ ‡ç­¾é•¿åº¦ â‰¤ 20
   }
   ```
   ```typescript
   const productSchema = z.object({
     id: z.string()._____,
     price: z.number()._____,
     tags: z.array(_____)
   });
   ```

3. **ï¼ˆå¡«ç©ºï¼‰valibot ä¸­çš„ `union` æ–¹æ³•ç”¨äºå®šä¹‰____ç±»å‹ï¼Œä¾‹å¦‚ï¼š**
   ```typescript
   const paymentMethod = union([literal("credit_card"), literal("paypal")]);
   // è¿™è¡¨ç¤ºå­—æ®µåªèƒ½æ˜¯____æˆ–____ã€‚
   ```

## æ‰©å±•é˜…è¯»

- [zod å®˜æ–¹æ–‡æ¡£](https://github.com/colinhacks/zod)
- [valibot å®˜æ–¹æ–‡æ¡£](https://valibot.dev/)
- [TypeScript ä¸ zod ç»“åˆçš„æœ€ä½³å®è·µ](https://dev.to/micromata/using-zod-with-typescript-2020)
- [è¿è¡Œæ—¶éªŒè¯ vs é™æ€ç±»å‹æ£€æŸ¥](https://blog.logrocket.com/a-comparison-of-runtime-type-checking-libraries-for-javascript/)
