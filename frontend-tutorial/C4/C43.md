# C43. MVVM è®¾è®¡ä¸å®ç°

## 3.1. ç»„åˆå¼ API ç®€åŒ–é€‰é¡¹å¼ API çš„ä»£ç ç»“æ„å’Œç±»å‹æ¨æ–­

> **ç»„åˆå¼ APIï¼ˆComposition APIï¼‰** æ˜¯ Vue 3 çš„æ ¸å¿ƒæ”¹è¿›ï¼Œé€šè¿‡ `setup()` å‡½æ•°é›†ä¸­ç®¡ç†å“åº”å¼æ•°æ®å’Œé€»è¾‘ï¼Œæ›¿ä»£ Vue 2 çš„é€‰é¡¹å¼ APIï¼ˆå¦‚ `data`, `methods`ï¼‰ã€‚

### ğŸ”„ å¯¹æ¯”ç¤ºä¾‹ï¼š

#### **é€‰é¡¹å¼ APIï¼ˆVue 2ï¼‰**ï¼š

```vue
<template>
  <p>{{ message }}</p>
  <button @click="increment">+1</button>
</template>

<script>
export default {
  data() {
    return {
      message: 'Hello Vue!',
      count: 0,
    };
  },
  methods: {
    increment() {
      this.count++;
      this.message = `Count is ${this.count}`;
    },
  },
};
</script>
```

#### **ç»„åˆå¼ APIï¼ˆVue 3ï¼‰**ï¼š

```vue
<template>
  <p>{{ message }}</p>
  <button @click="increment">+1</button>
</template>

<script setup>
import { ref } from 'vue';

const message = ref('Hello Vue!');
const count = ref(0);

const increment = () => {
  count.value++;
  message.value = `Count is ${count.value}`;
};
</script>
```

### ğŸ” ä¼˜åŠ¿ï¼š

1. **ä»£ç ç»“æ„åŒ–**ï¼š
   - é€»è¾‘æŒ‰åŠŸèƒ½ç»„ç»‡ï¼ˆå¦‚ `setup()` ä¸­å®šä¹‰æ•°æ®å’Œæ–¹æ³•ï¼‰ã€‚
   - é¿å…é€‰é¡¹å¼ API çš„â€œæ•°æ®åˆ†æ•£â€é—®é¢˜ã€‚
2. **ç±»å‹æ¨æ–­**ï¼š
   - ä½¿ç”¨ TypeScript æ—¶ï¼Œæ— éœ€é¢å¤–æ³¨è§£å³å¯æ¨æ–­ç±»å‹ã€‚
   ```typescript
   const count: Ref<number> = ref(0);  // è‡ªåŠ¨æ¨æ–­ç±»å‹
   ```

## 3.2. å“åº”å¼çš„åº•å±‚æ˜¯ Proxy ä»£ç†

> **Vue 3 å“åº”å¼ç³»ç»Ÿ** åŸºäº ES6 çš„ **Proxy å¯¹è±¡**ï¼Œæ›¿ä»£ Vue 2 çš„ `Object.defineProperty`ï¼Œå®ç°æ›´å…¨é¢çš„æ‹¦æˆªå’Œæ€§èƒ½ä¼˜åŒ–ã€‚

### ğŸ•¶ï¸ æ ¸å¿ƒåŸç†ï¼š
1. **Proxy æ‹¦æˆªæ“ä½œ**ï¼š
   - ç›‘å¬ `get`ã€`set` ç­‰æ“ä½œï¼Œè‡ªåŠ¨è§¦å‘ä¾èµ–æ”¶é›†å’Œè§†å›¾æ›´æ–°ã€‚
2. **æ•°ç»„å˜åŒ–æ£€æµ‹**ï¼š
   - ç›´æ¥æ”¯æŒ `push`ã€`splice` ç­‰å˜å¼‚æ–¹æ³•çš„æ‹¦æˆªï¼Œæ— éœ€ `Vue.set`ã€‚

### ğŸ§ª ç¤ºä¾‹ä»£ç ï¼š
```javascript
const originalData = { count: 0 };
const reactiveData = new Proxy(originalData, {
  get(target, key) {
    console.log(`è¯»å– ${key} çš„å€¼`);
    return target[key];
  },
  set(target, key, value) {
    console.log(`è®¾ç½® ${key} ä¸º ${value}`);
    target[key] = value;
    // è§¦å‘è§†å›¾æ›´æ–°
    notifyViews();
  },
});

reactiveData.count++;  // è§¦å‘ get å’Œ set
```

::: warning
- **Vue å†…éƒ¨å°è£…**ï¼šå¼€å‘è€…æ— éœ€ç›´æ¥æ“ä½œ Proxyï¼Œé€šè¿‡ `ref`/`reactive` ä½¿ç”¨ã€‚
- **å…¼å®¹æ€§**ï¼šES5 ç¯å¢ƒéœ€ polyfillï¼Œä½†ç°ä»£æµè§ˆå™¨å·²æ”¯æŒã€‚
:::

## 3.3. watch å‡½æ•°ä¾¦æµ‹å“åº”å¼æ•°æ®å˜åŒ–çš„åŸç†

> **`watch`** æ˜¯ Vue ç›‘å¬æ•°æ®å˜åŒ–çš„æ ¸å¿ƒå‡½æ•°ï¼Œé€šè¿‡ **ä¾èµ–æ”¶é›†** å’Œ **å›è°ƒè§¦å‘** å®ç°å“åº”å¼æ›´æ–°ã€‚

### ğŸ”„ å·¥ä½œæµç¨‹ï¼š

1. **ä¾èµ–æ”¶é›†**ï¼š
   - åœ¨ `watch` å›è°ƒé¦–æ¬¡æ‰§è¡Œæ—¶ï¼Œè®°å½•ä¾èµ–çš„å“åº”å¼æ•°æ®ã€‚
2. **å˜åŒ–è§¦å‘**ï¼š
   - å½“ä¾èµ–çš„æ•°æ®å˜åŒ–æ—¶ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°ã€‚

### ğŸ“ åŸºç¡€ç”¨æ³•ï¼š

```vue
<script setup>
import { ref, watch } from 'vue';

const count = ref(0);
const message = ref('åˆå§‹');

// ç›‘å¬ count å˜åŒ–
watch(
  () => count.value,
  (newVal, oldVal) => {
    console.log(`count ä» ${oldVal} å˜ä¸º ${newVal}`);
    message.value = `æœ€æ–°å€¼ï¼š${newVal}`;
  }
);
</script>
```

## 3.4. watch å‡½æ•°çš„è¿›é˜¶ç”¨æ³•

> **`watch`** æ”¯æŒæ·±åº¦ç›‘å¬ã€ç«‹å³æ‰§è¡Œã€æ‰‹åŠ¨åœæ­¢ç­‰é«˜çº§åŠŸèƒ½ã€‚

### ğŸ’¡ è¿›é˜¶å‚æ•°ï¼š
1. **æ·±åº¦ç›‘å¬ï¼ˆ`deep`ï¼‰**ï¼š
   ```javascript
   const user = reactive({ name: 'å¼ ä¸‰', age: 25 });
   watch(
     () => user,
     (newVal, oldVal) => {
       // ç›‘å¬å¯¹è±¡æ‰€æœ‰å±æ€§
     },
     { deep: true }
   );
   ```

2. **ç«‹å³æ‰§è¡Œï¼ˆ`immediate`ï¼‰**ï¼š
   ```javascript
   watch(
     count,
     () => {},
     { immediate: true }  // åˆå§‹åŒ–æ—¶ç«‹å³è§¦å‘
   );
   ```

3. **åœæ­¢ç›‘å¬**ï¼š
   ```javascript
   const stop = watch(count, () => { /* ... */ });
   stop();  // åœæ­¢ç›‘å¬
   ```

4. **å¼‚æ­¥æ›´æ–°**ï¼š
   ```javascript
   watch(
     searchQuery,
     () => {
       // å»¶è¿Ÿ 500ms åæ‰§è¡Œ
     },
     { flush: 'post' }
   );
   ```

## 3.5. Vue å¤„ç†æ•°æ®å˜åŒ–çš„åº•å±‚é€»è¾‘

> **Vue å“åº”å¼æµç¨‹** å¯åˆ†ä¸º **ä¾èµ–æ”¶é›†** å’Œ **è§¦å‘æ›´æ–°** ä¸¤å¤§é˜¶æ®µã€‚

### ğŸ”„ æµç¨‹å›¾ï¼š

```mermaid
graph TD
    A[æ•°æ®å˜åŒ–] --> B{è§¦å‘ get/set}
    B --> C[Proxy æ‹¦æˆªæ“ä½œ]
    C --> D[è®°å½•ä¾èµ–]
    D --> E[ä¾èµ–æ”¶é›†ï¼ˆå¦‚ watch æˆ–æ¸²æŸ“å‡½æ•°ï¼‰]
    E --> F[å¼‚æ­¥é˜Ÿåˆ—ï¼ˆé˜²æŠ–ä¼˜åŒ–ï¼‰]
    F --> G[æ‰§è¡Œæ›´æ–°]
    G --> H[é‡æ–°æ¸²æŸ“è§†å›¾]
```

### ğŸ” å…³é”®æ­¥éª¤ï¼š

1. **ä¾èµ–æ”¶é›†**ï¼š
   - åœ¨æ¸²æŸ“æˆ– `watch` æ‰§è¡Œæ—¶ï¼ŒVue è®°å½•å½“å‰è®¿é—®çš„å“åº”å¼æ•°æ®ã€‚
2. **è§¦å‘æ›´æ–°**ï¼š
   - å½“æ•°æ®å˜åŒ–æ—¶ï¼ŒVue å°†æ›´æ–°ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œé¿å…é‡å¤æ¸²æŸ“ã€‚
3. **é«˜æ•ˆæ¸²æŸ“**ï¼š
   - é€šè¿‡ **è™šæ‹Ÿ DOM** å¯¹æ¯”å·®å¼‚ï¼Œä»…æ›´æ–°å¿…è¦èŠ‚ç‚¹ã€‚

## çŸ¥è¯†å›é¡¾

1. **ç»„åˆå¼ API**ï¼š
   - é€šè¿‡ `setup()` é›†ä¸­ç®¡ç†é€»è¾‘ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§ã€‚
   - TypeScript ç±»å‹æ¨æ–­ç®€åŒ–å¼€å‘ã€‚
2. **å“åº”å¼åŸç†**ï¼š
   - Proxy ä»£ç†å®ç°å…¨é¢æ‹¦æˆªï¼Œæ”¯æŒæ•°ç»„å’Œå¯¹è±¡çš„æ·±å±‚å˜åŒ–ã€‚
3. **watch æœºåˆ¶**ï¼š
   - ç›‘å¬æ•°æ®å˜åŒ–ï¼Œæ”¯æŒæ·±åº¦ã€å¼‚æ­¥å’Œæ‰‹åŠ¨åœæ­¢ã€‚
4. **æ›´æ–°æµç¨‹**ï¼š
   - ä¾èµ–æ”¶é›† â†’ å¼‚æ­¥é˜Ÿåˆ— â†’ è§†å›¾æ›´æ–°ï¼Œç¡®ä¿é«˜æ•ˆæ¸²æŸ“ã€‚

## è¯¾åç»ƒä¹ 

1. **å•é€‰é¢˜**ï¼š
   Vue 3 ä¸­ï¼Œä»¥ä¸‹å“ªé¡¹æ˜¯ç»„åˆå¼ API çš„æ ¸å¿ƒå‡½æ•°ï¼Ÿ
   - A. `data()`
   - B. `setup()`
   - C. `methods`
   - D. `computed`

2. **å¡«ç©ºé¢˜**ï¼š
   Vue 3 å“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯______å¯¹è±¡ï¼Œæ›¿ä»£äº† Vue 2 çš„______æ–¹æ³•ã€‚

3. **ä»£ç çº é”™**ï¼š
   ä¿®å¤ä»¥ä¸‹ `watch` çš„ç›‘å¬é—®é¢˜ï¼š
   ```javascript
   watch(count, (newVal) => {
     console.log('count å˜åŒ–äº†ï¼');
   });
   // å‡è®¾ count æ˜¯ ref(0)
   ```

4. **æ“ä½œé¢˜**ï¼š
   ä½¿ç”¨ `watch` ç›‘å¬ä»¥ä¸‹å¯¹è±¡çš„ `name` å±æ€§å˜åŒ–ï¼Œå¹¶åœ¨æ§åˆ¶å°è¾“å‡ºæ–°æ—§å€¼ï¼š
   ```javascript
   const user = reactive({ name: 'å¼ ä¸‰', age: 25 });
   ```

5. **æ‰©å±•é¢˜**ï¼š
   åˆ†æä»¥ä¸‹ä»£ç çš„è¾“å‡ºé¡ºåºï¼Œå¹¶è§£é‡ŠåŸå› ï¼š
   ```javascript
   const count = ref(0);
   watch(count, () => console.log('watch è§¦å‘'));
   console.log('åˆå§‹æ¸²æŸ“');
   count.value = 1;
   ```
